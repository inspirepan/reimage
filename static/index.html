<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Image Reproduce Tool</title>
    <link
      href="https://cdn.jsdelivr.net/npm/@fontsource/ibm-plex-mono/400.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/@fontsource/ibm-plex-mono/500.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/@fontsource/ibm-plex-mono/700.css"
      rel="stylesheet"
    />
    <style>
      :root {
        --bg-body: #ededed;
        --bg-container: #f0f0f0;
        --bg-card: #f0f0f0;
        --border: #c8c8c8;
        --text: #111111;
        --text-dim: #64748b;
        --accent: #0851b2;
        --accent-hover: #064090;
        --accent-dim: rgba(8, 145, 178, 0.08);
        --success: #15803d;
        --error: #dc2626;
        --bg-error: #ffebee;
        --bg-code: #f3f3f3;
        --font-sans: "IBM Plex Mono", "SF Mono", Menlo, monospace;
        --font-mono: "IBM Plex Mono", "SF Mono", Menlo, monospace;
        --font-weight-bold: 700;
        --font-size-xs: 13px;
        --font-size-sm: 14px;
        --font-size-base: 16px;
        --font-size-lg: 18px;
        --radius-md: 6px;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        background-color: var(--bg-body);
        color: var(--text);
        font-family: var(--font-sans);
        line-height: 1.6;
        font-size: var(--font-size-base);
        -webkit-font-smoothing: antialiased;
        padding: 20px;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        overflow-x: hidden;
      }

      h1 {
        font-size: 20px;
        font-weight: var(--font-weight-bold);
        margin-bottom: 24px;
        color: var(--text);
        border-bottom: 1px solid var(--border);
        padding-bottom: 16px;
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .main-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
        flex: 1;
      }

      .column:nth-child(3) {
        grid-column: 1 / -1;
        min-height: 500px;
      }

      .column {
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: var(--radius-md);
        display: flex;
        flex-direction: column;
        overflow: hidden;
        box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.03);
        position: relative;
      }

      .action-btn {
        cursor: pointer;
        background-color: var(--accent);
        color: white;
        border: none;
        font-weight: var(--font-weight-bold);
        padding: 6px 12px;
        transition: background-color 0.2s;
        text-transform: uppercase;
        border-radius: var(--radius-md);
        font-size: var(--font-size-xs);
      }

      .column-header {
        padding: 12px 16px;
        border-bottom: 1px solid var(--border);
        font-weight: var(--font-weight-bold);
        font-size: var(--font-size-sm);
        color: var(--text);
        background: var(--bg-container);
        text-transform: uppercase;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-shrink: 0;
        min-height: 56px;
      }

      .column-content {
        flex: 1;
        overflow-y: auto;
        padding: 16px;
        display: flex;
        flex-direction: column;
        gap: 16px;
      }

      .section {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      label {
        font-size: var(--font-size-sm);
        font-weight: var(--font-weight-bold);
        text-transform: uppercase;
        color: var(--text-dim);
      }

      select,
      input,
      textarea,
      button {
        font-family: var(--font-mono);
        padding: 10px;
        border: 1px solid var(--border);
        border-radius: var(--radius-md);
        font-size: var(--font-size-sm);
        background-color: var(--bg-body);
        color: var(--text);
      }

      select {
        appearance: none;
        -webkit-appearance: none;
        -moz-appearance: none;
        background-image: url("data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3E%3Cpath stroke='%2364748b' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3E%3C/SVG%3E");
        background-position: right 12px center;
        background-repeat: no-repeat;
        background-size: 20px 20px;
        padding-right: 40px;
        cursor: pointer;
      }

      select:focus,
      input:focus,
      textarea:focus {
        outline: none;
        border-color: var(--accent);
        box-shadow: 0 0 0 2px var(--accent-dim);
      }

      textarea {
        resize: none;
      }

      .action-btn {
        cursor: pointer;
        background-color: var(--accent);
        color: white;
        border: none;
        font-weight: var(--font-weight-bold);
        padding: 6px 12px;
        transition: background-color 0.2s;
        text-transform: uppercase;
        border-radius: var(--radius-md);
        font-size: var(--font-size-xs);
      }

      .action-btn:hover {
        background-color: var(--accent-hover);
      }

      .action-btn:disabled {
        background-color: var(--text-dim);
        cursor: not-allowed;
        opacity: 0.5;
      }

      /* Upload Area */
      #upload-area {
        border: 2px dashed var(--border);
        border-radius: var(--radius-md);
        padding: 16px;
        text-align: center;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 120px;
        background-color: var(--bg-body);
        color: var(--text-dim);
        position: relative;
      }

      #upload-area:hover,
      #upload-area.dragover {
        border-color: var(--accent);
        background-color: var(--accent-dim);
        color: var(--accent);
      }

      #preview-image {
        max-width: 100%;
        max-height: 200px;
        display: none;
        border-radius: 4px;
        border: 1px solid var(--border);
      }

      #upload-placeholder {
        color: var(--text-secondary);
        font-size: 0.85rem;
      }

      /* Result Area */
      #generated-image-container {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background-color: var(--bg-body);
        border: 1px dashed var(--border);
        border-radius: var(--radius-md);
        padding: 16px;
        overflow: hidden;
        min-height: 200px;
      }

      #generated-image {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
        display: none;
        border-radius: 4px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }

      .loader {
        border: 3px solid var(--border);
        border-top: 3px solid var(--accent);
        border-radius: 50%;
        width: 24px;
        height: 24px;
        animation: spin 1s linear infinite;
        display: none;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      /* Utility for expanding textareas */
      .flex-grow {
        flex: 1;
        display: flex;
        flex-direction: column;
      }
      .flex-grow textarea {
        flex: 1;
        resize: vertical;
      }

      /* Details/Summary */
      details {
        background: transparent;
        margin-bottom: 4px;
      }
      summary {
        padding: 4px 0;
        font-family: var(--font-mono);
        font-size: var(--font-size-sm);
        text-transform: uppercase;
        font-weight: var(--font-weight-bold);
        cursor: pointer;
        user-select: none;
        list-style: none;
        display: flex;
        align-items: center;
        gap: 8px;
        color: var(--text-dim);
        transition: color 0.2s;
      }
      summary:hover,
      details[open] > summary {
        color: var(--text);
      }
      summary::-webkit-details-marker {
        display: none;
      }
      summary::before {
        content: "[+]";
        color: var(--accent);
        font-family: var(--font-mono);
        margin-right: 4px;
        display: inline-block;
        min-width: 24px;
      }
      details[open] > summary::before {
        content: "[-]";
      }
      details textarea {
        width: 100%;
        margin-top: 8px;
        resize: vertical;
      }

      #download-btn {
        padding: 4px 8px;
        font-size: var(--font-size-xs);
        font-family: var(--font-mono);
        cursor: pointer;
        border: 1px solid var(--border);
        background: var(--bg-body);
        border-radius: 4px;
        display: none;
        text-transform: uppercase;
        font-weight: bold;
        color: var(--text);
      }
      #download-btn:hover {
        border-color: var(--accent);
        color: var(--accent);
      }

      /* Custom Select Styles */
      .custom-select-wrapper {
        position: relative;
        width: 100%;
        font-family: var(--font-mono);
        font-size: var(--font-size-xs);
        user-select: none;
      }

      .custom-select-trigger {
        padding: 8px 10px;
        border: 1px solid var(--border);
        border-radius: var(--radius-md);
        background-color: var(--bg-body);
        color: var(--text);
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: all 0.15s ease-in-out;
        min-height: 36px;
      }

      .custom-select-trigger:hover {
        border-color: var(--accent);
      }

      .custom-select-trigger.active {
        border-color: var(--accent);
        box-shadow: 0 0 0 2px var(--accent-dim);
      }

      .custom-select-arrow {
        width: 16px;
        height: 16px;
        background-image: url("data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3E%3Cpath stroke='%2364748b' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3E%3C/SVG%3E");
        background-position: center;
        background-repeat: no-repeat;
        background-size: contain;
        transition: transform 0.2s;
        opacity: 0.7;
      }

      .custom-select-trigger.active .custom-select-arrow {
        transform: rotate(180deg);
      }

      .custom-select-options {
        position: fixed;
        max-height: 240px;
        overflow-y: auto;
        background-color: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: var(--radius-md);
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1),
          0 4px 6px -2px rgba(0, 0, 0, 0.05);
        z-index: 9999;
        display: none;
        padding: 4px;
        font-size: var(--font-size-xs);
      }

      .custom-select-options.open {
        display: block;
      }

      .custom-option {
        padding: 6px 8px;
        cursor: pointer;
        border-radius: 4px;
        color: var(--text);
        transition: background-color 0.1s;
      }

      .custom-option:hover {
        background-color: var(--accent-dim);
        color: var(--accent);
      }

      .custom-option.selected {
        background-color: var(--accent);
        color: white;
      }
    </style>
  </head>
  <body>
    <h1>ReImage</h1>

    <div class="main-grid">
      <!-- Column 1: Input Source & Config -->
      <div class="column">
        <div class="column-header">
          <span>1. Image Source & Config</span>
          <button id="analyze-btn" class="action-btn" disabled>
            Start Analysis
          </button>
        </div>
        <div class="column-content">
          <!-- Image Upload -->
          <div class="section">
            <div
              style="
                display: flex;
                justify-content: space-between;
                align-items: center;
              "
            >
              <label>Original Image</label>
              <button
                id="random-btn"
                style="
                  padding: 4px 8px;
                  font-size: 12px;
                  cursor: pointer;
                  border: 1px solid var(--border);
                  background: var(--bg-body);
                  border-radius: 4px;
                  text-transform: uppercase;
                  font-weight: bold;
                  color: var(--text-dim);
                "
              >
                random
              </button>
            </div>
            <input
              type="file"
              id="upload-input"
              accept="image/*"
              style="display: none"
            />
            <div id="upload-area">
              <div id="upload-placeholder">
                <svg
                  style="
                    width: 24px;
                    height: 24px;
                    margin: 0 auto 8px;
                    display: block;
                    opacity: 0.5;
                  "
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"
                  ></path>
                </svg>
                Click or Drag to Upload
              </div>
              <img id="preview-image" alt="Preview" />
            </div>
          </div>

          <!-- VLM Config -->
          <div class="section">
            <label for="vlm-model-select">Analysis Model (VLM)</label>
            <select id="vlm-model-select" style="width: 100%">
              <option value="">Loading...</option>
            </select>
          </div>

          <!-- Prompts -->
          <div class="section">
            <label>Prompt Configuration</label>
            <details open>
              <summary>System Prompt</summary>
              <textarea
                id="system-prompt"
                rows="4"
                placeholder="Loading system prompt..."
              ></textarea>
            </details>
            <div style="height: 8px"></div>
            <details open>
              <summary>User Prompt</summary>
              <textarea
                id="user-prompt"
                rows="4"
                placeholder="Loading user prompt..."
              ></textarea>
            </details>
          </div>
        </div>
      </div>

      <!-- Column 2: Prompt Engineering -->
      <div class="column">
        <div class="column-header">
          <span>2. Prompt Generation & Image Gen</span>
          <button id="generate-btn" class="action-btn" disabled>
            Generate Image
          </button>
        </div>
        <div class="column-content">
          <div class="section flex-grow">
            <div
              style="
                display: flex;
                justify-content: space-between;
                align-items: center;
              "
            >
              <label for="image-prompt"
                >Generated Image Prompt (Editable)</label
              >
              <span
                id="vlm-status"
                style="font-size: 0.8rem; color: var(--accent)"
              ></span>
            </div>
            <textarea
              id="image-prompt"
              placeholder="Click 'Analyze' to generate prompt, or enter here directly..."
            ></textarea>
          </div>

          <div class="section">
            <label for="gen-model-select">Generation Model</label>
            <select id="gen-model-select" style="width: 100%">
              <option value="">Loading...</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Column 3: Result -->
      <div class="column">
        <div class="column-header">
          <span>3. Results</span>
          <button id="download-btn">Download</button>
        </div>
        <div class="column-content">
          <div id="generated-image-container">
            <div class="loader" id="gen-loader"></div>
            <img id="generated-image" alt="Generated Image" />
            <div
              id="gen-placeholder"
              style="text-align: center; color: var(--text-dim)"
            >
              <p>Waiting for generation...</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", async () => {
        await Promise.all([loadPrompts(), loadModels()]);
        initCustomSelects();
      });

      const uploadArea = document.getElementById("upload-area");
      const uploadInput = document.getElementById("upload-input");
      const previewImage = document.getElementById("preview-image");
      const uploadPlaceholder = document.getElementById("upload-placeholder");
      const analyzeBtn = document.getElementById("analyze-btn");
      const imagePrompt = document.getElementById("image-prompt");
      const generateBtn = document.getElementById("generate-btn");
      const genLoader = document.getElementById("gen-loader");
      const generatedImage = document.getElementById("generated-image");
      const genPlaceholder = document.getElementById("gen-placeholder");
      const systemPromptInput = document.getElementById("system-prompt");
      const userPromptInput = document.getElementById("user-prompt");
      const vlmStatus = document.getElementById("vlm-status");
      const downloadBtn = document.getElementById("download-btn");
      const randomBtn = document.getElementById("random-btn");

      let currentBase64Image = null;
      let analyzeAbortController = null;
      let generateAbortController = null;

      async function loadPrompts() {
        try {
          const res = await fetch("/api/prompts");
          if (res.ok) {
            const data = await res.json();
            systemPromptInput.value = data.system_prompt;
            userPromptInput.value = data.user_prompt;
          }
        } catch (e) {
          console.error("Failed to load prompts", e);
        }
      }

      async function loadModels() {
        const vlmSelect = document.getElementById("vlm-model-select");
        const genSelect = document.getElementById("gen-model-select");
        try {
          const res = await fetch("/api/models");
          if (res.ok) {
            const data = await res.json();
            vlmSelect.innerHTML = data.vlm_models
              .map((m) => `<option value="${m.id}">${m.name}</option>`)
              .join("");
            genSelect.innerHTML = data.generation_models
              .map((m) => `<option value="${m.id}">${m.name}</option>`)
              .join("");
          }
        } catch (e) {
          console.error("Failed to load models", e);
          vlmSelect.innerHTML = '<option value="">Load failed</option>';
          genSelect.innerHTML = '<option value="">Load failed</option>';
        }
      }

      // --- UI State Management ---
      function updateButtonStates() {
        const isAnalyzing = !!analyzeAbortController;
        const isGenerating = !!generateAbortController;
        const hasImage = !!currentBase64Image;
        const hasPrompt = imagePrompt.value.trim().length > 0;

        if (isAnalyzing) {
          // Analyzing running
          analyzeBtn.disabled = false; // Allow cancel
          analyzeBtn.textContent = "Cancel Analysis";
          generateBtn.disabled = true; // Mutual exclusion
        } else if (isGenerating) {
          // Generating running
          analyzeBtn.disabled = true; // Mutual exclusion
          generateBtn.disabled = false; // Allow cancel
          generateBtn.textContent = "Cancel Generation";
        } else {
          // Idle
          analyzeBtn.disabled = !hasImage;
          analyzeBtn.textContent = "Start Analysis";

          generateBtn.disabled = !hasPrompt;
          generateBtn.textContent = "Generate Image";
        }
      }

      // Hook up updateButtonStates
      imagePrompt.addEventListener("input", updateButtonStates);

      // --- Random Image Logic ---
      randomBtn.addEventListener("click", async () => {
        try {
          randomBtn.disabled = true;
          randomBtn.textContent = "loading...";
          uploadPlaceholder.style.display = "block";
          uploadPlaceholder.innerHTML = "<p>Fetching random image...</p>";
          previewImage.style.display = "none";

          const res = await fetch("/api/random-image");
          if (!res.ok) throw new Error("Failed to fetch");
          const data = await res.json();

          currentBase64Image = data.image;
          previewImage.src = currentBase64Image;
          previewImage.style.display = "block";
          uploadPlaceholder.style.display = "none";
          updateButtonStates(); // Update state
        } catch (e) {
          console.error(e);
          alert("Failed to load random image");
          uploadPlaceholder.innerHTML = originalPlaceholderContent;
        } finally {
          randomBtn.disabled = false;
          randomBtn.textContent = "random";
        }
      });

      // Cache original placeholder content
      const originalPlaceholderContent = uploadPlaceholder.innerHTML;

      // --- Image Upload Logic ---
      function handleFile(file) {
        if (!file || !file.type.startsWith("image/")) {
          alert("Please upload an image file");
          return;
        }
        const reader = new FileReader();
        reader.onload = (e) => {
          currentBase64Image = e.target.result;
          previewImage.src = currentBase64Image;
          previewImage.style.display = "block";
          uploadPlaceholder.style.display = "none";
          updateButtonStates(); // Update state
        };
        reader.readAsDataURL(file);
      }

      uploadArea.addEventListener("click", () => uploadInput.click());
      uploadInput.addEventListener("change", (e) => {
        if (e.target.files && e.target.files[0]) handleFile(e.target.files[0]);
      });
      uploadArea.addEventListener("dragover", (e) => {
        e.preventDefault();
        uploadArea.classList.add("dragover");
      });
      uploadArea.addEventListener("dragleave", () =>
        uploadArea.classList.remove("dragover")
      );
      uploadArea.addEventListener("drop", (e) => {
        e.preventDefault();
        uploadArea.classList.remove("dragover");
        if (e.dataTransfer.files && e.dataTransfer.files[0])
          handleFile(e.dataTransfer.files[0]);
      });
      document.addEventListener("paste", (e) => {
        const items = e.clipboardData.items;
        for (let i = 0; i < items.length; i++) {
          if (items[i].type.indexOf("image") !== -1) {
            handleFile(items[i].getAsFile());
            break;
          }
        }
      });

      // --- VLM Analysis Logic (Streaming) ---
      analyzeBtn.addEventListener("click", async () => {
        // Handle cancel if already running
        if (analyzeAbortController) {
          analyzeAbortController.abort();
          analyzeAbortController = null;
          vlmStatus.textContent = "Cancelled";
          updateButtonStates();
          return;
        }

        if (!currentBase64Image) return;

        analyzeAbortController = new AbortController();
        updateButtonStates(); // Set state to analyzing

        imagePrompt.value = ""; // Clear
        vlmStatus.textContent = "Receiving stream output...";

        const payload = {
          image: currentBase64Image,
          model: document.getElementById("vlm-model-select").value,
          system_prompt: systemPromptInput.value,
          user_prompt: userPromptInput.value,
        };

        try {
          const response = await fetch("/api/analyze", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
            signal: analyzeAbortController.signal,
          });

          if (!response.ok) throw new Error(response.statusText);

          const reader = response.body.getReader();
          const decoder = new TextDecoder();
          let buffer = "";

          while (true) {
            const { done, value } = await reader.read();
            if (done) break;

            buffer += decoder.decode(value, { stream: true });
            const lines = buffer.split("\n");
            buffer = lines.pop();

            for (const line of lines) {
              if (line.startsWith("data: ")) {
                let content = line.slice(6);
                if (content.startsWith("{'error':")) {
                  imagePrompt.value += "\nError: " + content;
                } else {
                  try {
                    if (content.trim() === "[DONE]") continue;
                    const data = JSON.parse(content);
                    const text = data.choices?.[0]?.delta?.content || "";
                    if (text) {
                      imagePrompt.value += text;
                      imagePrompt.scrollTop = imagePrompt.scrollHeight;
                      // Note: While analyzing, generateBtn remains disabled by isAnalyzing check, so we don't update states here
                    }
                  } catch (e) {
                    console.log("Stream parse error", e);
                  }
                }
              }
            }
          }
          vlmStatus.textContent = "Analysis complete";
        } catch (err) {
          if (err.name === "AbortError") {
            vlmStatus.textContent = "Cancelled";
          } else {
            console.error(err);
            imagePrompt.value += "\nError calling VLM API";
            vlmStatus.textContent = "Error";
          }
        } finally {
          analyzeAbortController = null;
          updateButtonStates(); // Reset state (will enable generate if prompt exists)
        }
      });

      // --- Image Generation Logic ---
      generateBtn.addEventListener("click", async () => {
        // Handle cancel if already running
        if (generateAbortController) {
          generateAbortController.abort();
          generateAbortController = null;
          genLoader.style.display = "none";
          genPlaceholder.style.display = "block";
          genPlaceholder.innerHTML = "<p>Cancelled</p>";
          updateButtonStates();
          return;
        }

        const prompt = imagePrompt.value.trim();
        if (!prompt) return;

        generateAbortController = new AbortController();
        updateButtonStates(); // Set state to generating

        genLoader.style.display = "block";
        generatedImage.style.display = "none";
        genPlaceholder.style.display = "none";

        try {
          const response = await fetch("/api/generate", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              prompt: prompt,
              model: document.getElementById("gen-model-select").value,
            }),
            signal: generateAbortController.signal,
          });

          if (!response.ok) {
            const errData = await response.json();
            throw new Error(errData.detail || "Generation failed");
          }

          const data = await response.json();
          generatedImage.src = data.image;
          generatedImage.style.display = "block";
          downloadBtn.style.display = "block";

          // Scroll to the result column (slide down)
          setTimeout(() => {
            const resultColumn = document.querySelector(
              ".main-grid .column:last-child"
            );
            if (resultColumn) {
              resultColumn.scrollIntoView({
                behavior: "smooth",
                block: "start",
              });
            }
          }, 100);

          // Download logic
          downloadBtn.onclick = () => {
            const a = document.createElement("a");
            a.href = data.image;
            a.download = "generated-image.png"; // or jpg depending on data
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
          };
        } catch (err) {
          if (err.name === "AbortError") {
            genPlaceholder.style.display = "block";
            genPlaceholder.innerHTML = "<p>Cancelled</p>";
          } else {
            console.error(err);
            alert("Generation failed: " + err.message);
            genPlaceholder.style.display = "block";
            genPlaceholder.textContent = "Generation failed, please retry";
          }
        } finally {
          generateAbortController = null;
          genLoader.style.display = "none";
          updateButtonStates(); // Reset state
        }
      });

      function initCustomSelects() {
        const selects = document.querySelectorAll("select");
        if (selects.length === 0) return;

        // Helper to close all dropdowns
        const closeAll = () => {
          document.querySelectorAll(".custom-select-options").forEach((el) => {
            el.classList.remove("open");
            if (document.body.contains(el)) {
              document.body.removeChild(el);
            }
          });
          document
            .querySelectorAll(".custom-select-trigger")
            .forEach((el) => el.classList.remove("active"));
        };

        // Global listeners to close dropdowns
        window.addEventListener("click", (e) => {
          if (
            !e.target.closest(".custom-select-trigger") &&
            !e.target.closest(".custom-select-options")
          ) {
            closeAll();
          }
        });

        window.addEventListener("scroll", closeAll, true);
        window.addEventListener("resize", closeAll);

        selects.forEach((select) => {
          // Avoid double init
          if (
            select.nextElementSibling &&
            select.nextElementSibling.classList.contains(
              "custom-select-wrapper"
            )
          )
            return;

          const wrapper = document.createElement("div");
          wrapper.className = "custom-select-wrapper";

          const trigger = document.createElement("div");
          trigger.className = "custom-select-trigger";

          const textSpan = document.createElement("span");
          const arrow = document.createElement("div");
          arrow.className = "custom-select-arrow";

          trigger.appendChild(textSpan);
          trigger.appendChild(arrow);

          const optionsDiv = document.createElement("div");
          optionsDiv.className = "custom-select-options";

          const setup = () => {
            const selectedOption = select.options[select.selectedIndex];
            textSpan.textContent = selectedOption
              ? selectedOption.text
              : "Select...";
          };

          const refreshOptions = () => {
            optionsDiv.innerHTML = "";
            Array.from(select.options).forEach((opt) => {
              const div = document.createElement("div");
              div.className = "custom-option";
              div.textContent = opt.text;
              div.dataset.value = opt.value;
              if (select.value === opt.value) div.classList.add("selected");

              div.addEventListener("click", (e) => {
                e.stopPropagation();
                // Update original select
                select.value = opt.value;
                select.dispatchEvent(new Event("change", { bubbles: true }));

                // Update UI
                textSpan.textContent = opt.text;
                closeAll();
              });
              optionsDiv.appendChild(div);
            });
          };

          trigger.addEventListener("click", (e) => {
            e.stopPropagation();
            const wasOpen = optionsDiv.classList.contains("open");
            closeAll(); // Close others

            if (!wasOpen) {
              refreshOptions();

              const rect = trigger.getBoundingClientRect();
              optionsDiv.style.top = rect.bottom + 4 + "px";
              optionsDiv.style.left = rect.left + "px";
              optionsDiv.style.width = rect.width + "px";

              document.body.appendChild(optionsDiv);
              optionsDiv.classList.add("open");
              trigger.classList.add("active");
            }
          });

          setup();

          select.style.display = "none";
          select.parentNode.insertBefore(wrapper, select.nextSibling);
          wrapper.appendChild(trigger);
        });
      }
    </script>
  </body>
</html>
